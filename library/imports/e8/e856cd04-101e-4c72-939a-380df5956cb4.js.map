{"version":3,"sources":["assets/script/social/message.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import * as _G from '../system/all_modules';\nconst _ = _G._;\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class Message extends cc.Component {\n\n   onLoad() {\n   }\n\n   async initBase64Picture(targetNode: cc.Node) {\n      if (!targetNode.activeInHierarchy) targetNode.active = true;\n\n      const cameraNode = new cc.Node();\n      targetNode.addChild(cameraNode);\n      let cameraComp = cameraNode.addComponent(cc.Camera);\n      let texture = new cc.RenderTexture();\n\n      let gl = cc.game._renderContext;\n      texture.initWithSize(targetNode.width, targetNode.height, gl.STENCIL_INDEX8);\n      cameraComp.targetTexture = texture;\n      // cameraComp.zoomRatio = 3.2; // ratio for message of size: 640 x 420;\n      cameraComp.zoomRatio = 1.3;\n\n      cameraComp.backgroundColor = cc.Color.WHITE;\n      cameraComp.clearFlags = cc.Camera.ClearFlags.DEPTH | cc.Camera.ClearFlags.STENCIL | cc.Camera.ClearFlags.COLOR;\n      // cameraComp.cullingMask = 0xffffffff;\n\n      let width = texture.width;\n      let height = texture.height;\n      let _canvas = document.createElement('canvas');\n      _canvas.width = width;\n      _canvas.height = height;\n\n      let ctx = _canvas.getContext('2d');\n      cameraComp.render(targetNode);\n      let data = texture.readPixels();\n      // write the render data\n\n      let rowBytes = width * 4;\n      for (let row = 0; row < height; row++) {\n         let srow = height - 1 - row;\n         let data2 = new Uint8ClampedArray(data.buffer, srow * width * 4, rowBytes);\n         let imageData = new ImageData(data2, width, 1);\n         ctx.putImageData(imageData, 0, row);\n      }\n\n      const dataURL = _canvas.toDataURL(\"image/jpeg\");\n\n      setTimeout(() => {\n         targetNode.active = false;\n         cameraNode.removeFromParent();\n      }, 2000);\n\n      return dataURL;\n   }\n\n   async initPayload(target: cc.Node, content: string, ctaText: string, extraData?: any) {\n      try {\n         const dataObj = {\n            version: 'v2',\n            isFromNewsFeed: 1,\n            puzzle_id: extraData?.isNoPuzzleId ? null : _G.gameMechanic.currentCategoryName + '_' + _G.gameMechanic.currentFrameName,\n            ...(extraData || {}),\n         }\n         const base64Image = await this.initBase64Picture(target);\n         const payload = {\n            action: 'CUSTOM',\n            text: _G.localize.getMultilangugaeFBMessageObj(content),\n            // text: content,\n            cta: _G.localize.getMultilangugaeFBMessageObj(ctaText),\n            // cta: ctaText,\n            image: base64Image,\n            template: 'play_turn',\n            strategy: 'IMMEDIATE',\n            data: dataObj,\n            notification: 'PUSH',\n         };\n         _.log(`--------payload = `, payload);\n         return payload;\n      } catch (error) {\n         throw error;\n      }\n   }\n\n\n   async sendMessageScore() {\n      if (!window['FBInstant']) return;\n\n      // fill sahre node with current frames \n      const picNode = _.copyNode(_G.mapVisual.fullPicNode, cc.find('picture', this.node));\n      cc.find('capture_hard_mask', picNode).active = true;\n\n      try {\n         // const content = `${window['FBInstant']?.player.getName()} invites you to solve a puzzle!`;\n         // const ctaText = 'PLAY NOW';\n         const content = _G.localize.currentLanguageObject.fb_invite_message_text(FBInstant.player.getName());\n         const ctaText = _G.localize.currentLanguageObject.fb_invite_message_cta;\n\n         const payload = await this.initPayload(this.node, content, ctaText);\n         await FBInstant.updateAsync(payload);\n      } catch (error) {\n         _.log('sendMessageScore', error);\n      }\n   }\n\n   async sendMessageStillImage() {\n      if (!window['FBInstant']) return;\n      try {\n         // const content = `${window['FBInstant']?.player.getName()} invites you to solve a puzzle!`;\n         // const ctaText = 'PLAY NOW';\n         const content = _G.localize.currentLanguageObject.fb_invite_message_text(FBInstant.player.getName());\n         const ctaText = _G.localize.currentLanguageObject.fb_invite_message_cta;\n\n         const payload = await this.initPayload(this.node, content, ctaText, { isNoPuzzleId: true });\n         await FBInstant.updateAsync(payload);\n      } catch (error) {\n         _.log('sendMessageScore', error);\n      }\n   }\n\n}\n"]}