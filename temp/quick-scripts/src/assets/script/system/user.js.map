{"version":3,"sources":["assets/script/system/user.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import * as _G from './all_modules';\nconst { _, $ } = _G;\n\n\nconst callbackArr = [];\nconst dataFieldArr = [\n   'IsOldUser',\n   'exp',\n   'stars',\n   'playedGames',\n];\n\n\nexport const user = {\n   loginData: null,\n   entryPointData: {},\n   exp: 0,\n   stars: 0,\n   level: 0,\n   playedGames: null,\n   isPuzzleSpecified: false,\n   isVersionV2: false,\n\n   init() {\n      this.entryPointData = _G.utilsData.getEntryPointData();\n\n      // TESTTTTTTTTTTTTTTTTTTTTT \n      // this.entryPointData.puzzle_id = 'POSTER_frame02';\n      // this.entryPointData.version = 'v2'; // 'v2' or 'normal'\n      // TESTTTTTTTTTTTTTTTTTTTTT \n\n\n      // validate the puzzle_id to prevent outdated puzzle_id to cause error\n      const puzzleId = this.entryPointData.puzzle_id;\n      if (puzzleId) {\n         const [catName, frameName] = puzzleId.split('_');\n         const isCatNameValid = _G.levelManager.categoryNameArr.includes(catName);\n         if (!isCatNameValid) this.entryPointData.puzzle_id = null;\n         else {\n            const isFrameNameValid = _G.levelManager.getAvatarInfo(catName, frameName);\n            if (!isFrameNameValid) this.entryPointData.puzzle_id = null;\n         }\n      }\n\n\n      if (this.entryPointData.isFromNewsFeed) _G.analytic.logPageViewFromFeed(this.entryPointData.puzzle_id);\n\n      this.isPuzzleSpecified = this.entryPointData.puzzle_id;\n      this.isVersionV2 = this.isPuzzleSpecified && (this.entryPointData.version == 'v2');\n\n      // this.isPuzzleSpecified = null;\n      setTimeout(() => this.getFBData()); //delay 1 thread for other modules to register dataField\n\n   },\n\n   getFBData() {\n      _G.utilsData.load(dataFieldArr, (data) => {\n         this.loginData = data;\n         data.isNewUser = !data.IsOldUser;\n         _G.utilsData.save({ 'IsOldUser': true });\n\n         // fill exp, stars, level\n         this.stars = data.isNewUser ? _G.configGame.hintCoinPrice : (data.stars || 0);\n         this.exp = data.exp || 0;\n         this.level = this.expToLevel(this.exp);\n         this.playedGames = data.playedGames || {};\n         _G.coreUI.updateUserStats();\n\n         // call all the loginCallback\n         callbackArr.map(func => func(data));\n      });\n   },\n\n\n   addLoginDataFields(...args: any[]) {\n      args.map(fieldName => _.addUniqueElemToArr(dataFieldArr, fieldName))\n   },\n\n\n   addInitCallback(callbackFunc: Function) {\n      if (!this.loginData) callbackArr.push(callbackFunc);\n      else callbackFunc(this.loginData);\n   },\n\n\n   // Supportive\n   addStars(starNum, isSkipUpdateUI = false) {\n      this.stars = _.max(this.stars + starNum, 0);\n      _G.utilsData.save({ stars: this.stars });\n      _G.coreUI.updateUserStats(isSkipUpdateUI);\n   },\n\n   expToLevel(exp) {\n      return 1 + _.floor(this.exp / _G.configGame.levelUpExp);\n   },\n\n   addExp(exp, isSkipUpdateUIStars = false) {\n      const oldLevel = this.expToLevel(this.exp);\n      this.exp += exp;\n      const newLevel = this.level = this.expToLevel(this.exp);\n\n      _G.utilsData.save({ exp: this.exp });\n      _G.coreUI.updateUserStats(isSkipUpdateUIStars);\n      return newLevel != oldLevel;\n   },\n\n}"]}