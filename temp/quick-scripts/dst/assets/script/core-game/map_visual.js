
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/script/core-game/map_visual.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '8e0baH2ZLtGQb52+gG4oZRe', 'map_visual');
// script/core-game/map_visual.ts

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mapVisual = void 0;
var _G = require("../system/all_modules");
var _ = _G._, $ = _G.$;
var FRAME_WIDTH = 620;
var FRAME_HEIGHT = 775;
var ORG_FRAME_SIZE = 800;
var FRAME_SCALE = FRAME_WIDTH / ORG_FRAME_SIZE;
exports.mapVisual = {
    mainFrameWidth: FRAME_WIDTH,
    gridNode: null,
    fullPicNode: null,
    currentMaxCellX: 3,
    currentMaxCellY: 3,
    currentCellWidth: 100,
    currentCellHeight: 100,
    avatarSpriteFrame: null,
    isRealAvatarLoaded: false,
    init: function () {
        this.gridNode = cc.find('Canvas/play_area/scrollview_master/view/content/grid_area/grid_stack/grid');
        this.fullPicNode = cc.find('Canvas/sample_nodes/full_picture');
        var rootAvatarNode = cc.find('avatar', this.fullPicNode);
        this.avatarSpriteFrame = rootAvatarNode.getComponent(cc.Sprite).spriteFrame;
        this.fillAvatarPicture(rootAvatarNode);
    },
    fillAvatarPicture: function (rootAvatarNode) {
        var _this = this;
        if (window['FBInstant']) {
            var avatarUrl = FBInstant.player.getPhoto();
            _G.utilsUI.setNodeSpriteFromUrl(rootAvatarNode, avatarUrl, function (texture) {
                _this.isRealAvatarLoaded = true;
                var newSFrame = new cc.SpriteFrame(texture);
                _this.avatarSpriteFrame = newSFrame;
                _G.utilsUI.setNodeSprite(cc.find('Canvas/sample_nodes/sample_frame_cell/mask/avatar'), newSFrame);
                // const fillAvatarAsSample = (realAvatarNode, sampleAvatarNode) => {
                //    _G.utilsUI.setNodeSprite(realAvatarNode, newSFrame);
                //    _.setTimeout(() => {
                //       const smallerSampleSize = _.min(sampleAvatarNode.width, sampleAvatarNode.height);
                //       realAvatarNode.scale = _.max(smallerSampleSize / realAvatarNode.width, smallerSampleSize / realAvatarNode.height);
                //    });
                // };
                // top avatar
                // const topAvatarNode = cc.find('user_bar/avatar_mask/avatar', _G.coreUI.headerContainer);
                // const sampleAvatarNode = cc.find('sample_avatar', topAvatarNode.parent);
                // fillAvatarAsSample(topAvatarNode, sampleAvatarNode);
                _G.categoryList.setupAllFrameAvatars();
            });
        }
    },
    clearMap: function (callback) {
        var _this = this;
        _G.coreFX.hideGrid(function () {
            _this.gridNode.removeAllChildren();
            if (callback)
                callback();
        });
    },
    render: function (levelInfo, callback) {
        var _a = levelInfo.maxCellX, maxCellX = _a === void 0 ? 3 : _a, _b = levelInfo.maxCellY, maxCellY = _b === void 0 ? 3 : _b, categoryName = levelInfo.categoryName, frameName = levelInfo.frameName;
        var frameNode = cc.find('frame', this.fullPicNode);
        // handle the fullPic
        if (categoryName && frameName) {
            if (categoryName != 'tutorial') {
                var sFrame = _G.resources.frameSprites[categoryName][frameName];
                _G.utilsUI.setNodeSprite(frameNode, sFrame);
            }
            this.setAvatar(categoryName, frameName, frameNode); // setup avatar
        }
        var sampleNode = cc.find('Canvas/sample_nodes/cell');
        this.currentMaxCellX = maxCellX;
        this.currentMaxCellY = maxCellY;
        this.currentCellWidth = FRAME_WIDTH / maxCellX;
        this.currentCellHeight = FRAME_HEIGHT / maxCellX;
        for (var x = 1; x <= maxCellX; x++) {
            for (var y = 1; y <= maxCellY; y++) {
                var newCellNode = _.copyNode(sampleNode, this.gridNode);
                newCellNode.name = x + '_' + y;
                newCellNode.orgCellPos = { x: x, y: y };
                // set up the frame node
                newCellNode.width = this.currentCellWidth;
                newCellNode.height = this.currentCellHeight;
                var cellPicNode = _.copyNode(this.fullPicNode, cc.find('mask', newCellNode));
                this.setCellNodePos(newCellNode, x, y, true);
                cellPicNode.position = newCellNode.position.mul(-1);
                _G.control.bindCellTap(newCellNode); // bind control
                // handle the mask size manually (widgets cause performance slowdown)
                var maskNode = cc.find('mask', newCellNode);
                maskNode.width = newCellNode.width - 4;
                maskNode.height = newCellNode.height - 4;
                // handle the hint-glow
                var glowNode = cc.find('border_highlight/hint_glow', newCellNode);
                glowNode.width = newCellNode.width * 1.33;
                glowNode.height = newCellNode.height + newCellNode.width * 0.33;
            }
        }
        if (callback)
            callback();
    },
    // adjust avatar position, size, angle from level.avatar_info
    setAvatar: function (categoryName, frameName, frameNode, avatarNode, frameScale, frameSize) {
        if (frameScale === void 0) { frameScale = FRAME_SCALE; }
        if (frameSize === void 0) { frameSize = FRAME_WIDTH; }
        avatarNode = avatarNode || cc.find('avatar', this.fullPicNode);
        var avatarInfo = _G.levelManager.getAvatarInfo(categoryName, frameName);
        if (categoryName == 'tutorial')
            avatarInfo = _G.tutorial.frameAvatarInfo;
        var aCorrectX, aCorrectY;
        if (avatarNode.width < avatarNode.height) {
            avatarNode.anchorX = 0;
            avatarNode.anchorY = 0.5 * (1 + avatarNode.width / avatarNode.height);
        }
        else {
            avatarNode.anchorY = 1;
            avatarNode.anchorX = 0.5 * (1 - avatarNode.height / avatarNode.width);
        }
        var _a = [avatarInfo.width, avatarInfo.height, avatarInfo.x, avatarInfo.y].map(function (factor) { return factor * frameScale; }), aWidth = _a[0], aHeight = _a[1], aX = _a[2], aY = _a[3];
        avatarNode.scale = _.max(aWidth / avatarNode.width, aHeight / avatarNode.height);
        aCorrectX = aX - frameSize / 2;
        aCorrectY = frameNode.height / 2 - aY;
        avatarNode.setPosition(aCorrectX, aCorrectY);
        // set the correct angle
        avatarNode.x += avatarNode.width * avatarNode.scale * (0.5 - avatarNode.anchorX);
        avatarNode.y += avatarNode.height * avatarNode.scale * (0.5 - avatarNode.anchorY);
        avatarNode.anchorX = avatarNode.anchorY = 0.5;
        avatarNode.angle = avatarInfo.angle || 0;
    },
    setCellNodePos: function (cellNode, cellX, cellY, isInit) {
        if (isInit === void 0) { isInit = false; }
        cellNode.setPosition(this.cellPosToCoordinate(cellX, cellY));
        cellNode.cellPos = { x: cellX, y: cellY };
        if (!isInit)
            _G.gameMechanic.checkCellInCorrectPos(cellNode);
    },
    swapCellAnim: function (cellNode1, cellNode2, callback) {
        var _this = this;
        _G.mapVisual.bringCellsToTop(cellNode1, cellNode2);
        var tmpCellPos = cellNode1.cellPos;
        var coord1 = this.cellPosToCoordinate(cellNode1.cellPos.x, cellNode1.cellPos.y);
        var coord2 = this.cellPosToCoordinate(cellNode2.cellPos.x, cellNode2.cellPos.y);
        var speed = 1200;
        var distance = coord1.sub(coord2).mag();
        var fxTime = distance / speed;
        var scaleTween = cc.tween().to(fxTime * 0.2, { scale: 1.1 }).delay(fxTime * 0.6).to(fxTime * 0.2, { scale: 1 });
        scaleTween.clone(cellNode1).start();
        scaleTween.clone(cellNode2).start();
        cc.tween(cellNode1).to(fxTime, { position: coord2 }).start();
        cc.tween(cellNode2).to(fxTime, { position: coord1 }).start();
        _G.audio.playSound('card-swap');
        _.setTimeout(function () {
            _this.setCellNodePos(cellNode1, cellNode2.cellPos.x, cellNode2.cellPos.y);
            _this.setCellNodePos(cellNode2, tmpCellPos.x, tmpCellPos.y);
            if (callback)
                callback();
        }, fxTime * 1000);
    },
    bringCellsToTop: function () {
        var cellNodeArr = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            cellNodeArr[_i] = arguments[_i];
        }
        this.gridNode.children.map(function (cellNode) {
            cellNode.zIndex = cellNodeArr.includes(cellNode) ? 2 : 1;
        });
    },
    // ====================================
    // ===== SUPPORTIVE
    cellPosToCoordinate: function (cellX, cellY) {
        return cc.v2((cellX - (this.currentMaxCellX + 1) / 2) * this.currentCellWidth, (cellY - (this.currentMaxCellY + 1) / 2) * this.currentCellHeight);
    },
};

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9zY3JpcHQvY29yZS1nYW1lL21hcF92aXN1YWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMENBQTRDO0FBQ3BDLElBQUEsQ0FBQyxHQUFRLEVBQUUsRUFBVixFQUFFLENBQUMsR0FBSyxFQUFFLEVBQVAsQ0FBUTtBQUVwQixJQUFNLFdBQVcsR0FBRyxHQUFHLENBQUM7QUFDeEIsSUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDO0FBQ3pCLElBQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQztBQUMzQixJQUFNLFdBQVcsR0FBRyxXQUFXLEdBQUcsY0FBYyxDQUFDO0FBRXBDLFFBQUEsU0FBUyxHQUFHO0lBQ3RCLGNBQWMsRUFBRSxXQUFXO0lBQzNCLFFBQVEsRUFBRSxJQUFlO0lBQ3pCLFdBQVcsRUFBRSxJQUFlO0lBRTVCLGVBQWUsRUFBRSxDQUFDO0lBQ2xCLGVBQWUsRUFBRSxDQUFDO0lBQ2xCLGdCQUFnQixFQUFFLEdBQUc7SUFDckIsaUJBQWlCLEVBQUUsR0FBRztJQUN0QixpQkFBaUIsRUFBRSxJQUFzQjtJQUN6QyxrQkFBa0IsRUFBRSxLQUFLO0lBRXpCLElBQUk7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsMkVBQTJFLENBQUMsQ0FBQztRQUNyRyxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUMvRCxJQUFNLGNBQWMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUU1RSxJQUFJLENBQUMsaUJBQWlCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELGlCQUFpQixZQUFDLGNB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RyxXQUFXLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FBQTtJQUNMLENBQUM7SUFHRCx1Q0FBdUM7SUFDdkMsbUJBQW1CO0lBRW5CLG1CQUFtQixZQUFDLEtBQUssRUFBRSxLQUFLO1FBQzdCLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FDVCxDQUFDLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUNoRSxDQUFDLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUNuRSxDQUFDO0lBQ0wsQ0FBQztDQUVILENBQUEiLCJmaWxlIjoiIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfRyBmcm9tICcuLi9zeXN0ZW0vYWxsX21vZHVsZXMnO1xuY29uc3QgeyBfLCAkIH0gPSBfRztcblxuY29uc3QgRlJBTUVfV0lEVEggPSA2MjA7XG5jb25zdCBGUkFNRV9IRUlHSFQgPSA3NzU7XG5jb25zdCBPUkdfRlJBTUVfU0laRSA9IDgwMDtcbmNvbnN0IEZSQU1FX1NDQUxFID0gRlJBTUVfV0lEVEggLyBPUkdfRlJBTUVfU0laRTtcblxuZXhwb3J0IGNvbnN0IG1hcFZpc3VhbCA9IHtcbiAgIG1haW5GcmFtZVdpZHRoOiBGUkFNRV9XSURUSCxcbiAgIGdyaWROb2RlOiBudWxsIGFzIGNjLk5vZGUsXG4gICBmdWxsUGljTm9kZTogbnVsbCBhcyBjYy5Ob2RlLFxuXG4gICBjdXJyZW50TWF4Q2VsbFg6IDMsXG4gICBjdXJyZW50TWF4Q2VsbFk6IDMsXG4gICBjdXJyZW50Q2VsbFdpZHRoOiAxMDAsXG4gICBjdXJyZW50Q2VsbEhlaWdodDogMTAwLFxuICAgYXZhdGFyU3ByaXRlRnJhbWU6IG51bGwgYXMgY2MuU3ByaXRlRnJhbWUsXG4gICBpc1JlYWxBdmF0YXJMb2FkZWQ6IGZhbHNlLFxuXG4gICBpbml0KCkge1xuICAgICAgdGhpcy5ncmlkTm9kZSA9IGNjLmZpbmQoJ0NhbnZhcy9wbGF5X2FyZWEvc2Nyb2xsdmlld19tYXN0ZXIvdmlldy9jb250ZW50L2dyaWRfYXJlYS9ncmlkX3N0YWNrL2dyaWQnKTtcbiAgICAgIHRoaXMuZnVsbFBpY05vZGUgPSBjYy5maW5kKCdDYW52YXMvc2FtcGxlX25vZGVzL2Z1bGxfcGljdHVyZScpO1xuICAgICAgY29uc3Qgcm9vdEF2YXRhck5vZGUgPSBjYy5maW5kKCdhdmF0YXInLCB0aGlzLmZ1bGxQaWNOb2RlKTtcbiAgICAgIHRoaXMuYXZhdGFyU3ByaXRlRnJhbWUgPSByb290QXZhdGFyTm9kZS5nZXRDb21wb25lbnQoY2MuU3ByaXRlKS5zcHJpdGVGcmFtZTtcblxuICAgICAgdGhpcy5maWxsQXZhdGFyUGljdHVyZShyb290QXZhdGFyTm9kZSk7XG4gICB9LFxuXG4gICBmaWxsQXZhdGFyUGljdHVyZShyb290QXZhdGFyTm9kZSkge1xuICAgICAgaWYgKHdpbmRvd1snRkJJbnN0YW50J10pIHtcbiAgICAgICAgIGNvbnN0IGF2YXRhclVybCA9IEZCSW5zdGFudC5wbGF5ZXIuZ2V0UGhvdG8oKTtcbiAgICAgICAgIF9HLnV0aWxzVUkuc2V0Tm9kZVNwcml0ZUZyb21Vcmwocm9vdEF2YXRhck5vZGUsIGF2YXRhclVybCwgKHRleHR1cmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaXNSZWFsQXZhdGFyTG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1NGcmFtZSA9IG5ldyBjYy5TcHJpdGVGcmFtZSh0ZXh0dXJlKTtcbiAgICAgICAgICAgIHRoaXMuYXZhdGFyU3ByaXRlRnJhbWUgPSBuZXdTRnJhbWU7XG4gICAgICAgICAgICBfRy51dGlsc1VJLnNldE5vZGVTcHJpdGUoY2MuZmluZCgnQ2FudmFzL3NhbXBsZV9ub2Rlcy9zYW1wbGVfZnJhbWVfY2VsbC9tYXNrL2F2YXRhcicpLCBuZXdTRnJhbWUpO1xuXG4gICAgICAgICAgICAvLyBjb25zdCBmaWxsQXZhdGFyQXNTYW1wbGUgPSAocmVhbEF2YXRhck5vZGUsIHNhbXBsZUF2YXRhck5vZGUpID0+IHtcbiAgICAgICAgICAgIC8vICAgIF9HLnV0aWxzVUkuc2V0Tm9kZVNwcml0ZShyZWFsQXZhdGFyTm9kZSwgbmV3U0ZyYW1lKTtcbiAgICAgICAgICAgIC8vICAgIF8uc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAvLyAgICAgICBjb25zdCBzbWFsbGVyU2FtcGxlU2l6ZSA9IF8ubWluKHNhbXBsZUF2YXRhck5vZGUud2lkdGgsIHNhbXBsZUF2YXRhck5vZGUuaGVpZ2h0KTtcbiAgICAgICAgICAgIC8vICAgICAgIHJlYWxBdmF0YXJOb2RlLnNjYWxlID0gXy5tYXgoc21hbGxlclNhbXBsZVNpemUgLyByZWFsQXZhdGFyTm9kZS53aWR0aCwgc21hbGxlclNhbXBsZVNpemUgLyByZWFsQXZhdGFyTm9kZS5oZWlnaHQpO1xuICAgICAgICAgICAgLy8gICAgfSk7XG4gICAgICAgICAgICAvLyB9O1xuXG4gICAgICAgICAgICAvLyB0b3AgYXZhdGFyXG4gICAgICAgICAgICAvLyBjb25zdCB0b3BBdmF0YXJOb2RlID0gY2MuZmluZCgndXNlcl9iYXIvYXZhdGFyX21hc2svYXZhdGFyJywgX0cuY29yZVVJLmhlYWRlckNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBjb25zdCBzYW1wbGVBdmF0YXJOb2RlID0gY2MuZmluZCgnc2FtcGxlX2F2YXRhcicsIHRvcEF2YXRhck5vZGUucGFyZW50KTtcbiAgICAgICAgICAgIC8vIGZpbGxBdmF0YXJBc1NhbXBsZSh0b3BBdmF0YXJOb2RlLCBzYW1wbGVBdmF0YXJOb2RlKTtcblxuICAgICAgICAgICAgX0cuY2F0ZWdvcnlMaXN0LnNldHVwQWxsRnJhbWVBdmF0YXJzKCk7XG4gICAgICAgICB9KTtcbiAgICAgIH1cbiAgIH0sXG5cblxuICAgY2xlYXJNYXAoY2FsbGJhY2s/OiBGdW5jdGlvbikge1xuICAgICAgX0cuY29yZUZYLmhpZGVHcmlkKCgpID0+IHtcbiAgICAgICAgIHRoaXMuZ3JpZE5vZGUucmVtb3ZlQWxsQ2hpbGRyZW4oKTtcbiAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcbiAgICAgIH0pO1xuICAgfSxcblxuXG4gICByZW5kZXIobGV2ZWxJbmZvLCBjYWxsYmFjaz86IEZ1bmN0aW9uKSB7XG4gICAgICBjb25zdCB7IG1heENlbGxYID0gMywgbWF4Q2VsbFkgPSAzLCBjYXRlZ29yeU5hbWUsIGZyYW1lTmFtZSB9ID0gbGV2ZWxJbmZvO1xuICAgICAgY29uc3QgZnJhbWVOb2RlID0gY2MuZmluZCgnZnJhbWUnLCB0aGlzLmZ1bGxQaWNOb2RlKTtcblxuICAgICAgLy8gaGFuZGxlIHRoZSBmdWxsUGljXG4gICAgICBpZiAoY2F0ZWdvcnlOYW1lICYmIGZyYW1lTmFtZSkge1xuICAgICAgICAgaWYgKGNhdGVnb3J5TmFtZSAhPSAndHV0b3JpYWwnKSB7XG4gICAgICAgICAgICBjb25zdCBzRnJhbWUgPSBfRy5yZXNvdXJjZXMuZnJhbWVTcHJpdGVzW2NhdGVnb3J5TmFtZV1bZnJhbWVOYW1lXTtcbiAgICAgICAgICAgIF9HLnV0aWxzVUkuc2V0Tm9kZVNwcml0ZShmcmFtZU5vZGUsIHNGcmFtZSk7XG4gICAgICAgICB9XG4gICAgICAgICB0aGlzLnNldEF2YXRhcihjYXRlZ29yeU5hbWUsIGZyYW1lTmFtZSwgZnJhbWVOb2RlKTsgLy8gc2V0dXAgYXZhdGFyXG4gICAgICB9XG5cblxuICAgICAgY29uc3Qgc2FtcGxlTm9kZSA9IGNjLmZpbmQoJ0NhbnZhcy9zYW1wbGVfbm9kZXMvY2VsbCcpO1xuXG4gICAgICB0aGlzLmN1cnJlbnRNYXhDZWxsWCA9IG1heENlbGxYO1xuICAgICAgdGhpcy5jdXJyZW50TWF4Q2VsbFkgPSBtYXhDZWxsWTtcbiAgICAgIHRoaXMuY3VycmVudENlbGxXaWR0aCA9IEZSQU1FX1dJRFRIIC8gbWF4Q2VsbFg7XG4gICAgICB0aGlzLmN1cnJlbnRDZWxsSGVpZ2h0ID0gRlJBTUVfSEVJR0hUIC8gbWF4Q2VsbFg7XG5cbiAgICAgIGZvciAobGV0IHggPSAxOyB4IDw9IG1heENlbGxYOyB4KyspIHtcbiAgICAgICAgIGZvciAobGV0IHkgPSAxOyB5IDw9IG1heENlbGxZOyB5KyspIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld0NlbGxOb2RlID0gXy5jb3B5Tm9kZShzYW1wbGVOb2RlLCB0aGlzLmdyaWROb2RlKTtcbiAgICAgICAgICAgIG5ld0NlbGxOb2RlLm5hbWUgPSB4ICsgJ18nICsgeTtcbiAgICAgICAgICAgIG5ld0NlbGxOb2RlLm9yZ0NlbGxQb3MgPSB7IHgsIHkgfTtcblxuICAgICAgICAgICAgLy8gc2V0IHVwIHRoZSBmcmFtZSBub2RlXG4gICAgICAgICAgICBuZXdDZWxsTm9kZS53aWR0aCA9IHRoaXMuY3VycmVudENlbGxXaWR0aDtcbiAgICAgICAgICAgIG5ld0NlbGxOb2RlLmhlaWdodCA9IHRoaXMuY3VycmVudENlbGxIZWlnaHQ7XG4gICAgICAgICAgICBjb25zdCBjZWxsUGljTm9kZSA9IF8uY29weU5vZGUodGhpcy5mdWxsUGljTm9kZSwgY2MuZmluZCgnbWFzaycsIG5ld0NlbGxOb2RlKSk7XG4gICAgICAgICAgICB0aGlzLnNldENlbGxOb2RlUG9zKG5ld0NlbGxOb2RlLCB4LCB5LCB0cnVlKTtcbiAgICAgICAgICAgIGNlbGxQaWNOb2RlLnBvc2l0aW9uID0gbmV3Q2VsbE5vZGUucG9zaXRpb24ubXVsKC0xKTtcblxuXG4gICAgICAgICAgICBfRy5jb250cm9sLmJpbmRDZWxsVGFwKG5ld0NlbGxOb2RlKTsgLy8gYmluZCBjb250cm9sXG5cbiAgICAgICAgICAgIC8vIGhhbmRsZSB0aGUgbWFzayBzaXplIG1hbnVhbGx5ICh3aWRnZXRzIGNhdXNlIHBlcmZvcm1hbmNlIHNsb3dkb3duKVxuICAgICAgICAgICAgY29uc3QgbWFza05vZGUgPSBjYy5maW5kKCdtYXNrJywgbmV3Q2VsbE5vZGUpO1xuICAgICAgICAgICAgbWFza05vZGUud2lkdGggPSBuZXdDZWxsTm9kZS53aWR0aCAtIDQ7XG4gICAgICAgICAgICBtYXNrTm9kZS5oZWlnaHQgPSBuZXdDZWxsTm9kZS5oZWlnaHQgLSA0O1xuXG4gICAgICAgICAgICAvLyBoYW5kbGUgdGhlIGhpbnQtZ2xvd1xuICAgICAgICAgICAgY29uc3QgZ2xvd05vZGUgPSBjYy5maW5kKCdib3JkZXJfaGlnaGxpZ2h0L2hpbnRfZ2xvdycsIG5ld0NlbGxOb2RlKTtcbiAgICAgICAgICAgIGdsb3dOb2RlLndpZHRoID0gbmV3Q2VsbE5vZGUud2lkdGggKiAxLjMzO1xuICAgICAgICAgICAgZ2xvd05vZGUuaGVpZ2h0ID0gbmV3Q2VsbE5vZGUuaGVpZ2h0ICsgbmV3Q2VsbE5vZGUud2lkdGggKiAwLjMzO1xuICAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7XG4gICB9LFxuXG5cbiAgIC8vIGFkanVzdCBhdmF0YXIgcG9zaXRpb24sIHNpemUsIGFuZ2xlIGZyb20gbGV2ZWwuYXZhdGFyX2luZm9cbiAgIHNldEF2YXRhcihjYXRlZ29yeU5hbWUsIGZyYW1lTmFtZSwgZnJhbWVOb2RlLCBhdmF0YXJOb2RlPzogY2MuTm9kZSwgZnJhbWVTY2FsZSA9IEZSQU1FX1NDQUxFLCBmcmFtZVNpemUgPSBGUkFNRV9XSURUSCkge1xuICAgICAgYXZhdGFyTm9kZSA9IGF2YXRhck5vZGUgfHwgY2MuZmluZCgnYXZhdGFyJywgdGhpcy5mdWxsUGljTm9kZSk7XG4gICAgICBsZXQgYXZhdGFySW5mbyA9IF9HLmxldmVsTWFuYWdlci5nZXRBdmF0YXJJbmZvKGNhdGVnb3J5TmFtZSwgZnJhbWVOYW1lKTtcbiAgICAgIGlmIChjYXRlZ29yeU5hbWUgPT0gJ3R1dG9yaWFsJykgYXZhdGFySW5mbyA9IF9HLnR1dG9yaWFsLmZyYW1lQXZhdGFySW5mbztcblxuICAgICAgbGV0IGFDb3JyZWN0WCwgYUNvcnJlY3RZO1xuICAgICAgaWYgKGF2YXRhck5vZGUud2lkdGggPCBhdmF0YXJOb2RlLmhlaWdodCkge1xuICAgICAgICAgYXZhdGFyTm9kZS5hbmNob3JYID0gMDtcbiAgICAgICAgIGF2YXRhck5vZGUuYW5jaG9yWSA9IDAuNSAqICgxICsgYXZhdGFyTm9kZS53aWR0aCAvIGF2YXRhck5vZGUuaGVpZ2h0KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICAgYXZhdGFyTm9kZS5hbmNob3JZID0gMTtcbiAgICAgICAgIGF2YXRhck5vZGUuYW5jaG9yWCA9IDAuNSAqICgxIC0gYXZhdGFyTm9kZS5oZWlnaHQgLyBhdmF0YXJOb2RlLndpZHRoKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgW2FXaWR0aCwgYUhlaWdodCwgYVgsIGFZXSA9IFthdmF0YXJJbmZvLndpZHRoLCBhdmF0YXJJbmZvLmhlaWdodCwgYXZhdGFySW5mby54LCBhdmF0YXJJbmZvLnldLm1hcChmYWN0b3IgPT4gZmFjdG9yICogZnJhbWVTY2FsZSk7XG4gICAgICBhdmF0YXJOb2RlLnNjYWxlID0gXy5tYXgoYVdpZHRoIC8gYXZhdGFyTm9kZS53aWR0aCwgYUhlaWdodCAvIGF2YXRhck5vZGUuaGVpZ2h0KTtcblxuICAgICAgYUNvcnJlY3RYID0gYVggLSBmcmFtZVNpemUgLyAyO1xuICAgICAgYUNvcnJlY3RZID0gZnJhbWVOb2RlLmhlaWdodCAvIDIgLSBhWTtcbiAgICAgIGF2YXRhck5vZGUuc2V0UG9zaXRpb24oYUNvcnJlY3RYLCBhQ29ycmVjdFkpO1xuXG4gICAgICAvLyBzZXQgdGhlIGNvcnJlY3QgYW5nbGVcbiAgICAgIGF2YXRhck5vZGUueCArPSBhdmF0YXJOb2RlLndpZHRoICogYXZhdGFyTm9kZS5zY2FsZSAqICgwLjUgLSBhdmF0YXJOb2RlLmFuY2hvclgpO1xuICAgICAgYXZhdGFyTm9kZS55ICs9IGF2YXRhck5vZGUuaGVpZ2h0ICogYXZhdGFyTm9kZS5zY2FsZSAqICgwLjUgLSBhdmF0YXJOb2RlLmFuY2hvclkpO1xuICAgICAgYXZhdGFyTm9kZS5hbmNob3JYID0gYXZhdGFyTm9kZS5hbmNob3JZID0gMC41O1xuICAgICAgYXZhdGFyTm9kZS5hbmdsZSA9IGF2YXRhckluZm8uYW5nbGUgfHwgMDtcbiAgIH0sXG5cblxuICAgc2V0Q2VsbE5vZGVQb3MoY2VsbE5vZGUsIGNlbGxYLCBjZWxsWSwgaXNJbml0ID0gZmFsc2UpIHtcbiAgICAgIGNlbGxOb2RlLnNldFBvc2l0aW9uKHRoaXMuY2VsbFBvc1RvQ29vcmRpbmF0ZShjZWxsWCwgY2VsbFkpKTtcbiAgICAgIGNlbGxOb2RlLmNlbGxQb3MgPSB7IHg6IGNlbGxYLCB5OiBjZWxsWSB9O1xuICAgICAgaWYgKCFpc0luaXQpIF9HLmdhbWVNZWNoYW5pYy5jaGVja0NlbGxJbkNvcnJlY3RQb3MoY2VsbE5vZGUpO1xuICAgfSxcblxuICAgc3dhcENlbGxBbmltKGNlbGxOb2RlMTogY2MuTm9kZSwgY2VsbE5vZGUyOiBjYy5Ob2RlLCBjYWxsYmFjaz86IEZ1bmN0aW9uKSB7XG4gICAgICBfRy5tYXBWaXN1YWwuYnJpbmdDZWxsc1RvVG9wKGNlbGxOb2RlMSwgY2VsbE5vZGUyKTtcblxuICAgICAgY29uc3QgdG1wQ2VsbFBvcyA9IGNlbGxOb2RlMS5jZWxsUG9zO1xuICAgICAgY29uc3QgY29vcmQxID0gdGhpcy5jZWxsUG9zVG9Db29yZGluYXRlKGNlbGxOb2RlMS5jZWxsUG9zLngsIGNlbGxOb2RlMS5jZWxsUG9zLnkpO1xuICAgICAgY29uc3QgY29vcmQyID0gdGhpcy5jZWxsUG9zVG9Db29yZGluYXRlKGNlbGxOb2RlMi5jZWxsUG9zLngsIGNlbGxOb2RlMi5jZWxsUG9zLnkpO1xuXG4gICAgICBjb25zdCBzcGVlZCA9IDEyMDA7XG4gICAgICBjb25zdCBkaXN0YW5jZSA9IGNvb3JkMS5zdWIoY29vcmQyKS5tYWcoKTtcbiAgICAgIGNvbnN0IGZ4VGltZSA9IGRpc3RhbmNlIC8gc3BlZWQ7XG5cbiAgICAgIGNvbnN0IHNjYWxlVHdlZW4gPSBjYy50d2VlbigpLnRvKGZ4VGltZSAqIDAuMiwgeyBzY2FsZTogMS4xIH0pLmRlbGF5KGZ4VGltZSAqIDAuNikudG8oZnhUaW1lICogMC4yLCB7IHNjYWxlOiAxIH0pXG4gICAgICBzY2FsZVR3ZWVuLmNsb25lKGNlbGxOb2RlMSkuc3RhcnQoKTtcbiAgICAgIHNjYWxlVHdlZW4uY2xvbmUoY2VsbE5vZGUyKS5zdGFydCgpO1xuICAgICAgY2MudHdlZW4oY2VsbE5vZGUxKS50byhmeFRpbWUsIHsgcG9zaXRpb246IGNvb3JkMiB9KS5zdGFydCgpO1xuICAgICAgY2MudHdlZW4oY2VsbE5vZGUyKS50byhmeFRpbWUsIHsgcG9zaXRpb246IGNvb3JkMSB9KS5zdGFydCgpO1xuXG4gICAgICBfRy5hdWRpby5wbGF5U291bmQoJ2NhcmQtc3dhcCcpO1xuXG4gICAgICBfLnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgdGhpcy5zZXRDZWxsTm9kZVBvcyhjZWxsTm9kZTEsIGNlbGxOb2RlMi5jZWxsUG9zLngsIGNlbGxOb2RlMi5jZWxsUG9zLnkpO1xuICAgICAgICAgdGhpcy5zZXRDZWxsTm9kZVBvcyhjZWxsTm9kZTIsIHRtcENlbGxQb3MueCwgdG1wQ2VsbFBvcy55KTtcbiAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcbiAgICAgIH0sIGZ4VGltZSAqIDEwMDApO1xuICAgfSxcblxuXG4gICBicmluZ0NlbGxzVG9Ub3AoLi4uY2VsbE5vZGVBcnIpIHtcbiAgICAgIHRoaXMuZ3JpZE5vZGUuY2hpbGRyZW4ubWFwKGNlbGxOb2RlID0+IHtcbiAgICAgICAgIGNlbGxOb2RlLnpJbmRleCA9IGNlbGxOb2RlQXJyLmluY2x1ZGVzKGNlbGxOb2RlKSA/IDIgOiAxO1xuICAgICAgfSlcbiAgIH0sXG5cblxuICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAvLyA9PT09PSBTVVBQT1JUSVZFXG5cbiAgIGNlbGxQb3NUb0Nvb3JkaW5hdGUoY2VsbFgsIGNlbGxZKSB7XG4gICAgICByZXR1cm4gY2MudjIoXG4gICAgICAgICAoY2VsbFggLSAodGhpcy5jdXJyZW50TWF4Q2VsbFggKyAxKSAvIDIpICogdGhpcy5jdXJyZW50Q2VsbFdpZHRoLFxuICAgICAgICAgKGNlbGxZIC0gKHRoaXMuY3VycmVudE1heENlbGxZICsgMSkgLyAyKSAqIHRoaXMuY3VycmVudENlbGxIZWlnaHRcbiAgICAgICk7XG4gICB9LFxuXG59Il19